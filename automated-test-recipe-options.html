<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Options Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #5a5a5a;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffff00;
        }
    </style>
</head>
<body>
    <h1>Recipe Options Independence Test</h1>
    
    <div class="test-container">
        <h2>Test: Recipe Options Button Clicks</h2>
        <p>This test will simulate clicking Recipe Options buttons and monitor for unwanted card expansions.</p>
        
        <button onclick="runTest()">Run Automated Test</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = [];
        }

        async function runTest() {
            log('üöÄ Starting Recipe Options Independence Test');
            
            // Test 1: Navigate to explore-recipes page
            log('üìç Test 1: Loading explore-recipes page');
            try {
                const response = await fetch('/explore-recipes');
                if (response.ok) {
                    log('‚úÖ Page loaded successfully', 'success');
                } else {
                    log('‚ùå Failed to load page', 'error');
                }
            } catch (error) {
                log('‚ùå Network error: ' + error.message, 'error');
            }

            // Test 2: Check for console monitoring
            log('üìç Test 2: Setting up console monitoring');
            
            // Override console.log to capture app logs
            const originalLog = console.log;
            const capturedLogs = [];
            
            console.log = function(...args) {
                capturedLogs.push(args.join(' '));
                originalLog.apply(console, args);
            };

            // Test 3: Simulate button clicks
            log('üìç Test 3: Simulating Recipe Options button clicks');
            
            // Wait for page to be fully loaded
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test sequence
            const testSequence = [
                'Chef\'s Choice',
                'Pantry Dishes', 
                'Take-Out',
                'Create Dishes',
                'Chef\'s Choice', // Re-test
                'Pantry Dishes'   // Re-test
            ];

            for (let i = 0; i < testSequence.length; i++) {
                const buttonName = testSequence[i];
                log(`üîÑ Clicking ${buttonName} button (${i + 1}/${testSequence.length})`);
                
                // Simulate click on the NutraGenie app
                try {
                    // Check if we're in iframe context
                    if (window.parent !== window) {
                        // We're in an iframe, need to access parent
                        const parentDoc = window.parent.document;
                        const buttons = parentDoc.querySelectorAll('button');
                        
                        // Find the button with matching text
                        const targetButton = Array.from(buttons).find(btn => 
                            btn.textContent.trim() === buttonName
                        );
                        
                        if (targetButton) {
                            targetButton.click();
                            log(`‚úÖ Clicked ${buttonName} button`, 'success');
                            
                            // Wait for state updates
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // Check for unwanted expansions
                            const cardElements = parentDoc.querySelectorAll('[class*="card"]');
                            log(`üìä Found ${cardElements.length} card elements after click`);
                            
                        } else {
                            log(`‚ùå Could not find ${buttonName} button`, 'error');
                        }
                    } else {
                        log('‚ö†Ô∏è Not in iframe - cannot access NutraGenie app directly', 'warning');
                    }
                } catch (error) {
                    log(`‚ùå Error clicking ${buttonName}: ${error.message}`, 'error');
                }
                
                // Wait between clicks
                await new Promise(resolve => setTimeout(resolve, 1500));
            }

            // Test 4: Analyze captured logs
            log('üìç Test 4: Analyzing captured console logs');
            
            const cardPositioningLogs = capturedLogs.filter(log => 
                log.includes('CARD POSITIONING') || log.includes('üîÑ')
            );
            
            const recipeOptionLogs = capturedLogs.filter(log => 
                log.includes('Chef\'s Choice') || log.includes('Pantry Dishes') || log.includes('Take-Out')
            );

            log(`üìä Found ${cardPositioningLogs.length} card positioning logs`);
            log(`üìä Found ${recipeOptionLogs.length} recipe option logs`);

            if (cardPositioningLogs.length > 1) {
                log('‚ùå CRITICAL: Card positioning triggered multiple times!', 'error');
                cardPositioningLogs.forEach(logEntry => {
                    log(`   ${logEntry}`, 'error');
                });
            } else if (cardPositioningLogs.length === 1) {
                log('‚úÖ Card positioning triggered only once (expected)', 'success');
            } else {
                log('‚ö†Ô∏è No card positioning logs found', 'warning');
            }

            // Test 5: Check for coupling indicators
            log('üìç Test 5: Checking for coupling indicators');
            
            const couplingIndicators = [
                'EXPAND: Chevron down clicked',
                'TAB: Meal tab clicked',
                'TAB: Pantry tab clicked'
            ];

            let couplingFound = false;
            couplingIndicators.forEach(indicator => {
                const found = capturedLogs.some(log => log.includes(indicator));
                if (found) {
                    log(`‚ùå COUPLING DETECTED: ${indicator}`, 'error');
                    couplingFound = true;
                }
            });

            if (!couplingFound) {
                log('‚úÖ No coupling indicators found', 'success');
            }

            // Restore original console.log
            console.log = originalLog;

            // Final result
            log('üìç Test Complete - Results Summary:');
            if (cardPositioningLogs.length <= 1 && !couplingFound) {
                log('üéâ ALL TESTS PASSED: Recipe Options work independently!', 'success');
            } else {
                log('‚ùå TESTS FAILED: Recipe Options still coupled to card positioning', 'error');
            }
        }
    </script>
</body>
</html>